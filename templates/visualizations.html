{% extends "base.html" %}
{% block content %}
  <section class="panel grid">
    <header>
      <h1>Data visualisations</h1>
      <p class="muted">Interactive charts summarising use case trends.</p>
    </header>
    {% if not graphs %}
      {% if filters and active_filters %}
        <p class="muted">No visualisations match the selected filters.</p>
      {% else %}
        <p class="muted">No visualisations are available for your role yet.</p>
      {% endif %}
    {% endif %}
  </section>

  {% if filters %}
    <section class="panel">
      <form method="get" class="filters-form" aria-label="Data filters">
        <div class="filters-grid">
          {% for filter in filters %}
            <div class="filter-field">
              {% if filter.type == 'select' %}
                <details
                  class="filter-dropdown"
                  data-default-label="{{ filter.empty_label }}"
                >
                  <summary>
                    <span class="filter-summary">
                      <span class="filter-summary-label">{{ filter.label }}</span>
                      <span class="filter-summary-value">{{ filter.summary }}</span>
                    </span>
                    <span class="filter-summary-icon" aria-hidden="true"></span>
                  </summary>
                  <div class="filter-dropdown-options" role="group" aria-label="{{ filter.label }}">
                    {% for option in filter.options %}
                      <label class="filter-option">
                        <input
                          type="checkbox"
                          name="{{ filter.param }}"
                          value="{{ option.value }}"
                          {% if option.value in filter['values'] %}checked{% endif %}
                          data-label="{{ option.label }}"
                        >
                        <span>{{ option.label }}</span>
                      </label>
                    {% endfor %}
                    <button type="button" class="filter-clear" data-clear="true">Clear selection</button>
                  </div>
                </details>
                <small class="muted">{{ filter.help_text }}</small>
              {% elif filter.type == 'range' %}
                <span class="filter-range-label">{{ filter.label }}</span>
                <div class="filter-range-inputs">
                  <input
                    type="number"
                    id="{{ filter.min_param }}"
                    name="{{ filter.min_param }}"
                    value="{{ filter.current_min if filter.current_min is not none else '' }}"
                    placeholder="{{ filter.placeholder_min }}"
                    {% if filter.step %}step="{{ filter.step }}"{% endif %}
                    {% if filter.dataset_min is not none %}min="{{ filter.dataset_min }}"{% endif %}
                    aria-label="{{ filter.label }} minimum"
                  >
                  <span class="range-separator">to</span>
                  <input
                    type="number"
                    id="{{ filter.max_param }}"
                    name="{{ filter.max_param }}"
                    value="{{ filter.current_max if filter.current_max is not none else '' }}"
                    placeholder="{{ filter.placeholder_max }}"
                    {% if filter.step %}step="{{ filter.step }}"{% endif %}
                    {% if filter.dataset_max is not none %}max="{{ filter.dataset_max }}"{% endif %}
                    aria-label="{{ filter.label }} maximum"
                  >
                  {% if filter.unit %}
                    <small class="muted">{{ filter.unit }}</small>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="filters-actions">
          <button type="submit" class="button primary">Apply filters</button>
          {% if active_filters %}
            <a href="{{ url_for('visualizations') }}" class="button subtle">Clear filters ({{ active_filters }})</a>
          {% endif %}
        </div>
      </form>
    </section>
  {% endif %}

  {% if graphs %}
    <section class="cards charts-grid">
      {% for graph in graphs %}
        <article class="card chart-card">
          <header>
            <h2>{{ graph.title }}</h2>
          </header>
          <div class="chart-wrapper">
            <canvas id="{{ graph.element_id }}" aria-label="{{ graph.title }}" role="img"></canvas>
          </div>
          {% if graph.description %}
            <p class="muted small">{{ graph.description }}</p>
          {% endif %}
        </article>
      {% endfor %}
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function () {
      const dropdowns = document.querySelectorAll('.filter-dropdown');
      dropdowns.forEach((dropdown) => {
        const summaryValue = dropdown.querySelector('.filter-summary-value');
        const defaultLabel = dropdown.dataset.defaultLabel || 'All';
        const checkboxes = Array.from(
          dropdown.querySelectorAll('input[type="checkbox"]')
        );
        const clearButton = dropdown.querySelector('[data-clear]');

        const formatSummary = (labels) => {
          if (!labels.length) {
            return defaultLabel;
          }
          if (labels.length === 1) {
            return labels[0];
          }
          if (labels.length === 2) {
            return labels.join(', ');
          }
          return `${labels[0]}, ${labels[1]} +${labels.length - 2} more`;
        };

        const updateSummary = () => {
          const labels = checkboxes
            .filter((input) => input.checked)
            .map((input) => input.dataset.label || input.value);
          summaryValue.textContent = formatSummary(labels);
        };

        checkboxes.forEach((input) => {
          input.addEventListener('change', updateSummary);
        });

        if (clearButton) {
          clearButton.addEventListener('click', () => {
            checkboxes.forEach((input) => {
              input.checked = false;
            });
            updateSummary();
          });
        }

        updateSummary();
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const charts = {{ graphs | tojson }};
    charts.forEach((config) => {
      const canvas = document.getElementById(config.element_id);
      if (!canvas) return;
      const options = Object.assign({
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: config.chart_type === 'bar' ? 'top' : 'bottom' },
          tooltip: { enabled: true }
        }
      }, config.options || {});
      new Chart(canvas, {
        type: config.chart_type,
        data: {
          labels: config.labels,
          datasets: [config.dataset]
        },
        options
      });
    });
  </script>
{% endblock %}
